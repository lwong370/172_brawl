<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Lana Wong and Fabiola Gallardo (website template by Ryan Tsang)" />
  <title>172 Brawl: Embedded Systems Final Project</title>
  <!-- <link rel="stylesheet" type="text/css" href="assets/github-markdown-light.css" /> -->
  <link rel="stylesheet" href="assets/github-markdown-light.css" />
  <link rel="stylesheet" href="assets/style-customization.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<article class="markdown-body">
<header id="title-block-header">
<h1 class="title">172 Brawl: Embedded Systems Final Project</h1>
<!-- <p class="subtitle"><blockquote><b>EEC172 Final Project Webpage Example</b><br/> Note to current students: this is an <i>example</i> webpage and may not fulfill all stated requirements of the current quarter's assignment.<br/>The website source is hosted <a href="https://github.com/ucd-eec172/project-website-example">on github</a>. </blockquote></p> -->
<p class="author"><strong>Lana Wong and Fabiola Gallardo</strong></p>
<p class="date"><em>EEC172 SQ24</em></p>
<div class="abstract">
<div class="abstract-title"><h2>Description</h2></div>
172 Brawl is a multiplayer combat game that involves controlling each character with a 3200 Launchpad built-in accelerometer. 
Each player can shoot each other with the press of a button. Each player is allotted five hearts which tracks their life count. 
Every time a player is attacked, the number of hearts for that player decrements. The objective for each player is to kill their opponent. 
Once a player wins, an email is sent announcing who the winner is and the score for the winner.   
 <br/><br/> Our source code can be
found <!-- replace this link -->
<a href="https://github.com/ucd-eec172/project-website-example"> here
(placeholder)</a>.<br />
<div style="display:flex;flex-wrap:wrap;justify-content:space-evenly;padding-top:20px"> <div style="display: inline-block; vertical-align: bottom;"> <img src="./assets/172_brawl_closer_look.jpg" style="width:auto;height:2in"/> <!-- <span class="caption"> </span> --> </div> <div style="display: inline-block; vertical-align: bottom;"> <img src="./assets/172_brawl_action.jpg" style="width:auto;height:2in" /> <!-- <span class="caption"> </span> --> </div> </div>
<h2>Video Demo</h2>
<div style="text-align:center;margin:auto;max-width:560px">
    <div style="padding-bottom:56.25%;position:relative;height:0;">
        <iframe style="left:0;top:0;width:100%;height:100%;position:absolute;" width="560" height="315" src="https://www.youtube.com/embed/oa5vg_73MA8" title="YouTube video player" frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
    </div>
</div>
</div>
</header>
<nav id="TOC" role="doc-toc">
<h2 id="toc-title">Table of Contents</h2>
<ul>
<li><a href="#market-survey" id="toc-market-survey">Market
Survey</a></li>
<li><a href="#design" id="toc-design">Design</a>
<ul>
<li><a href="#system-architecture" id="toc-system-architecture">System
Architecture</a></li>
<li><a href="#functional-specification"
id="toc-functional-specification">Functional Specification</a></li>
</ul></li>
<li><a href="#implementation" id="toc-implementation">Implementation</a>
<ul>
<li><a href="#cc3200-launchxl-evaluation-board"
id="toc-cc3200-launchxl-evaluation-board">CC3200-LAUNCHXL Evaluation
Board</a></li>
<li><a href="#functional-blocks-master"
id="toc-functional-blocks-master">Functional Blocks</a>
<ul>
<li><a href="#oled-display" id="toc-oled-display">OLED Display</a></li>
<li><a href="#accelerometer-control" id="toc-accelerometer">Accelerometer Control</a></li>
<li><a href="#gpio-switch" id="toc-gpio-switch">GPIO Switch Button</a></li>
<li><a href="#aws-iot-core" id="toc-aws-iot-core">AWS IoT Core</a></li>

<!-- <li><a href="#ir-receiver" id="toc-ir-receiver">IR Receiver</a></li> -->
</ul></li>
</ul></li>
</ul></li>
<li><a href="#challenges" id="toc-challenges">Challenges</a>
<ul>
<li><a href="#uart-synchronization"
id="toc-uart-synchronization">UART Synchronization</a></li>
<li><a href="#gpio-switch-defect"
id="toc-gpio-switch-defect">GPIO Switch Defect
Pins</a></li>
<!-- <li><a href="#solution-to-challenges"
id="toc-solution-to-challenges">Solution to Challenges</a></li>
</ul></li> -->
<li><a href="#future-work" id="toc-future-work">Future Work</a></li>
<li><a href="#finalized-bom" id="toc-finalized-bom">Finalized
Bill of Materials</a></li>
</ul>
</nav>
<!-- EDIT METADATA ABOVE FOR CONTENTS TO APPEAR ABOVE THE TABLE OF CONTENTS -->

<!-- ALL CONTENT THAT FOLLWOWS WILL APPEAR IN AND AFTER THE TABLE OF CONTENTS -->

<h1 id="market-survey">Market Survey</h1>
<p>This game is inspired by the popular mobile combat game Brawl Stars. </p>
<div style="display:flex;flex-wrap:wrap;justify-content:space-evenly;">
  <!-- <div style='display: inline-block; vertical-align: top;'>
    <img src="./media/Image_003.jpg" style="width:auto;height:50"/>
    <span class="caption">
      <a>172 Brawl Game in action</a>
      <ul style="text-align:left;">
      <li>More physical control</li>
    </ul>
    </span>
  </div> -->
  <div style='display: inline-block; vertical-align: top;'>
    <img src="./assets/brawlstars.PNG" style="width:auto;height:50" />
    <span class="caption">
      <p>In Brawl Stars, control is done fully on the device screen. Unlike Brawl Stars, in 172 Brawl there is a physical and real control aspect where players use an actual device for ease of movement.</p>
      <!-- <a>Brawl Stars Game</a>
      <ul style="text-align:left;">
      <li>Control fully on device on the Brawl Stars game vs. being able to physically control movements and actions.</li>
    </ul> -->
    </span>
  </div>
</div>

<h1 id="design">Design</h1>
<h2 id="system-architecture">System Architecture</h2>
<div style="display:flex;flex-wrap:wrap;justify-content:space-evenly;">
  <div style="display:inline-block;vertical-align:top;flex:1 0 400px;">
    As shown in the system flowchart, we use one of the CC3200 boards for
    the closed feedback loop for maintaining concentration in the
    environment. The board will read values with I2C protocol through an ADC
    which reads values from the thermistor and the TDS meter sensor. The
    board will also periodically read user-defined thresholds from the AWS
    cloud using RESTful APIs. When the sensory values read outside of the
    user-defined thresholds, the board will activate the motor control
    function to pump either water or nutrient solution to bring the
    concentration back within the thresholds. Meanwhile, another CC3200
    board is frequently reading from the AWS cloud to present the current
    TDS reading and user-defined threshold to the user on an OLED through
    SPI protocols. To adjust the thresholds, the user can either do it
    remotely or locally by using a TV remote to type the number into the IR
    receiver. The adjustments will be updated to the AWS and if the user
    updates remotely, the local CC3200 board will update the values in the
    next synchronization.
  </div>
  <div style="display:inline-block;vertical-align:top;flex:0 0 400px;">
    <div class="fig">
      <img src="./media/Image_005.jpg" style="width:90%;height:auto;" />
      <span class="caption">System Flowchart</span>
    </div>
  </div>
</div>

<h2 id="functional-specification">Functional Specification</h2>
<div style="display:flex;flex-wrap:wrap;justify-content:space-evenly;">
  <div style="display:inline-block;vertical-align:top;flex:1 0 300px;">
    Our system works based on the following state diagram. The device will
    periodically monitor the temperature and the electrical conductivity
    (EC) of the solution and convert the values into a TDS value using a
    calibration curve. At the same time, the device will check for threshold
    inputs, both over the AWS shadow and via manual input on the IR
    receiver. It will compare the TDS with the lower and upper thresholds
    set by the user. If the value is within the thresholds, it will stay in
    the rest state. If the TDS is higher than the upper thresholds, it will
    go to the water state and activate the water pump until the PPM is lower
    than the upper thresholds and go back to the rest state. If the PPM is
    lower than the lower thresholds, it will go to the nutrient state and
    activate the nutrient pump until the PPM is higher than the lower
    thresholds and go back to the rest state. In each state, the device will
    periodically post the TDS.
  </div>
  <div style="display:inline-block;vertical-align:top;flex:0 0 500px">
    <div class="fig">
      <img src="./media/Image_006.jpg" style="width:90%;height:auto;" />
      <span class="caption">State Diagram</span>
    </div>
  </div>
</div>

<h1 id="implementation">Implementation</h1>
<h3 id="cc3200-launchxl-evaluation-board">CC3200-LAUNCHXL Evaluation
Board</h3>
<p>All control and logic was handled by two CC3200 microcontroller
units, one each for the Master and Slave device. On the master device,
it was responsible for decoding IR inputs from the remote to allow the
user to input thresholds to be sent over AWS. The boardâ€™s SPI
functionality, using the TI SPI library, was used to interface with the
OLED display. The MCU is WiFi enabled, allowing a remote connection
between the two boards.</p>
<p>On the slave device, the microcontroller was responsible for the same
functionalities as above, in addition to the TDS reading and control.
This includes interfacing with the ADC over the I2C bus, reading
thresholds over HTTP from the AWS device shadow, writing the reported
TDS to the device shadow, and activating the two pumps using the BJT
control circuit.</p>
<!-- <h2 id="functional-blocks-master">Functional Blocks: Master</h2> -->

<h3 id="oled-display">OLED Display</h3>
<div style="display:flex;flex-wrap:wrap;justify-content:space-between;">
  <div style='display: inline-block; vertical-align: top;flex:1 0 400px'>
    We connect to the OLED Display with the SPI (Serial Peripheral Interface) bus, with the CC32000 Launchpad as the mater device
    and the OLED as the slave.
  </div>
  <div style='display: inline-block; vertical-align: top;flex:0 0 400px'>
    <div class="fig">
      <img src="./assets/oled_spi_chart.png" style="width:auto;height:2in" />
      <span class="caption">OLED Wiring Diagram</span>
    </div>
  </div>
</div>

<h3 id="accelerometer-control">Accelerometer Control</h3>
<div style="display:flex;flex-wrap:wrap;justify-content:space-between;">
  <div style='display: inline-block; vertical-align: top;flex:1 0 200px'>
    
  </div>
  <div style='display: inline-block; vertical-align: top;flex:0 0 400px'>
    <div class="fig">
      <img src="./media/Image_007.jpg" style="width:auto;height:2.5in" />
      <span class="caption">Device Shadow JSON</span>
    </div>
  </div>
</div>

<h3 id="gpio-switch">GPIO Switch Button</h3>
<div style="display:flex;flex-wrap:wrap;justify-content:space-between;">
  <div style='display: inline-block; vertical-align: top;flex:1 0 200px'>
    To attack the opponent, a player must press SW3 of their CC3200. When the two players are within range of each other (which we defined in code as a 10 pixel radius), 
    the color of a player's character turns yellow on their console indicating that they can attack.
  </div>
  <div style='display: inline-block; vertical-align: top;flex:0 0 400px'>
    <div class="fig">
      <img src="./assets/sw3.png" style="width:auto;height:2.5in" />
      <span class="caption">SW3 on CC3200 Launchpad</span>
    </div>
  </div>
</div>

<h3 id="aws-iot-core">AWS IoT Core</h3>
<div style="display:flex;flex-wrap:wrap;justify-content:space-between;">
  <div style='display: inline-block; vertical-align: top;flex:1 0 200px'>
    In order to connect to AWS, we recycled our AWS Console set up from Lab 4. 
    That set up involved creating a 'Thing' to represent our CC3200 boards in the cloud, 
    as well as the policies and certificates to properly interface with the physical boards.
    In the code, we created a JSON format that we use to send to AWS as shown.
  </div>
  <div style='display: inline-block; vertical-align: top;flex:0 0 400px'>
    <div class="fig">
      <img src="./assets/aws_code.PNG" style="width:auto;height:2.5in" />
      <span class="caption">Device Shadow JSON</span>
    </div>
  </div>
</div>

<!-- <h3 id="ir-receiver">IR Receiver</h3>
<div style="display:flex;flex-wrap:wrap;justify-content:space-between;">
  <div style='display: inline-block; vertical-align: top;flex:1 0 400px'>
    On both the Master and Slave devices, a user can input the TDS
    thresholds using a TV remote. These TV remotes use the NEC code format
    with a carrier frequency of 38KHz. The Vishay IR receiver is connected
    to Pin 62 of the CC3200, which is configured as a GPIO input pin. Each
    positive edge of the signal triggers an interrupt in the main program,
    storing the pulse distances into a buffer, and allowing us to decode the
    inputs (1-9, delete and enter). The IR receiver is connected to VCC
    through a resistor and a capacitor to filter any ripples.
  </div>
  <div style='display: inline-block; vertical-align: top;flex:0 0 400px'>
    <div class="fig">
      <img src="./media/Image_009.jpg" style="width:auto;height:2in" />
      <span class="caption">IR Receiver Wiring Diagram</span>
    </div>
  </div> -->
<!-- </div> -->


<h1 id="challenges">Challenges</h1>
<p>The most significant challenge we faced while developing this
prototype was of inaccurate and inconsistent Electrical Conductivity
(EC) measurements. This occurred due to two reasons: probe channel
polarization and current limitations of GPIO pins.</p>
<h2 id="uart-synchronization">UART Synchronization</h2>
<p>Our first design for the probe was simply two copper rods, which
would add as electrodes. This probe would be connected in series with a
1000-ohm resistor to act as a voltage divider. We would simply connect
the probe to VCC and measure the voltage divider through the ADC,
allowing us to calculate the EC. However, when we used the probe for a
few minutes, we realized that the EC value would continue to rise. This
is because the DC current causes an ionized channel to build up between
the two electrodes in the water. This cause inconsistent EC readings as
time goes on.</p>
<h2 id="gpio-switch-defect">GPIO Switch Defect</h2>
<p>Our next idea was to try using the GPIO pins to power the probe,
since we can turn it off when not needed, preventing excessive
polarization. However, the GPIO pins are current limited, and any
control circuit with a transistor would introduce extra voltage drops.
Therefore, the simple two-probe implementation was not feasible.</p>
<!-- <h2 id="solution-to-challenges">Solution to Challenges</h2>
<p>We realized that using DC current to measure EC was not feasible.
Therefore, we purchased a standalone EC measurement board from CQRobot.
This inexpensive solution ($8) used a low-voltage, low-current AC signal
to prevent polarization. The board would convert the AC voltage drop
across the solution to a DC analog voltage, which would then be read by
our ADC. After calibrating the setup using a commercial TDS pen, the
results were accurate within 3%, and would not drift by more than 0.5%
over time.</p> -->
<h1 id="future-work">Future Work</h1>
<p>Given more time, we had the idea of developing a web app to allow
users to control the device from their cell phone. Another idea we
wanted to implement in the future is adding a grow light and pH
controller to maintain a more suitable and stable environment for
different plants to grow.</p>
<h1 id="finalized-bom">Finalized Bill Of Materials</h1>
<!-- you can convert google sheet cells to html for free using a converter
  like https://tabletomarkdown.com/convert-spreadsheet-to-html/ -->

<table style="border-collapse:collapse;">
<thead>
  <tr>
    <th><p>No.</p></th>
    <th><p>PART NAME</p></th>
    <th><p>DESCRIPTION</p></th>
    <th><p>Qty</p></th>
    <th><p>SUPPLIER / MANUFACTURER</p></th>
    <th><p>UNIT COST</p></th>
    <th><p>TOTAL PART COST</p></th>
    <th><p>Purpose</p></th>
  </tr>
</thead>
<tbody>
  <tr>
    <td><p>1</p></td>
    <td><p>CC3200-LAUNCHXL</p></td>
    <td><p>MCU Evaluation Board</p></td>
    <td><p>2</p></td>
    <td><p>Provided by EEC172 Course</p></td>
    <td><p>$66.00</p></td>
    <td><p>$132.00</p></td>
    <td><p>Control Remote and Local Devices</p></td>
  </tr>
  <tr>
    <td><p>2</p></td>
    <td><p>Adafruit 1431 OLED</p></td>
    <td><p>128x128 RGB OLED Display. SPI protocol</p></td>
    <td><p>2</p></td>
    <td><p>Provided by EEC172 Course</p></td>
    <td><p>$39.95</p></td>
    <td><p>$79.90</p></td>
    <td><p>Display the Game for each player</p></td>
  </tr>
  <!-- <tr>
    <td><p>3</p></td>
    <td><p>330 ohm resistor</p></td>
    <td><p>330 ohm resistor, &lt;5% tolerance, 3W</p></td>
    <td><p>2</p></td>
    <td><p>Provided by EEC172 Course</p></td>
    <td><p>$0.59</p></td>
    <td><p>$1.18</p></td>
    <td><p>Current Limit for IR Receiver</p></td>
  </tr>
  <tr>
    <td><p>4</p></td>
    <td><p>ATT-RC1534801 Remote</p></td>
    <td><p>General-purpose TV remote. IR NTC protocol</p></td>
    <td><p>1</p></td>
    <td><p>Provided by EEC172 Course</p></td>
    <td><p>$9.99</p></td>
    <td><p>$9.99</p></td>
    <td><p>Allow user inputs</p></td>
  </tr> -->
  <tr>
    <td colspan="3">
      <p>TOTAL PARTS</p></td>
    <td><p>4</p></td>
    <td colspan="2">
      <p>TOTAL</p></td>
    <td><p>$211.90</p></td>
    <td></td>
  </tr>
  <tr>
    <td colspan="3">
      <p>TOTAL PARTS (Excluding Provided)</p></td>
    <td><p>0</p></td>
    <td colspan="2">
      <p>TOTAL (Exluding Provided)</p></td>
    <td><p>$0.00</p></td>
    <td></td>
  </tr>
</tbody>
</table>
</article>
</html>
